<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Super TODO App</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs (using compat libraries) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    /* Optional: Set the font family globally */
    body { font-family: 'Roboto', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- LOGIN UI -->
  <div id="login-container" class="flex flex-col items-center justify-center h-screen bg-gray-100">
    <h1 class="text-3xl font-bold mb-4">Welcome to the Super TODO App</h1>
    <p class="mb-6 text-lg">Please sign in with Google to continue.</p>
    <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md">
      Sign In with Google
    </button>
  </div>

  <!-- APP CONTAINER (hidden until user is logged in) -->
  <div id="app-container" class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden hidden">
    <header class="bg-blue-600 text-white py-4 px-6 relative">
      <h1 class="text-2xl font-bold text-center">Super TODO App</h1>
      <button id="logout-button" class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
        Sign Out
      </button>
    </header>
    <!-- MAIN TABS NAVIGATION -->
    <nav id="main-tabs" class="flex bg-gray-200">
      <button class="tab-btn active flex-1 py-3 text-center font-semibold" data-tab="todos">Todos</button>
      <button class="tab-btn flex-1 py-3 text-center font-semibold" data-tab="friends">Friends</button>
      <button class="tab-btn flex-1 py-3 text-center font-semibold" data-tab="groups">Groups</button>
      <button class="tab-btn flex-1 py-3 text-center font-semibold" data-tab="notifications">Notifications</button>
    </nav>
    <div id="tab-contents">
      <!-- TODOS TAB -->
      <div id="todos-tab" class="active p-6">
        <div id="personal-todo-app">
          <!-- Section Tabs & Controls -->
          <nav>
            <ul id="section-tabs" class="section-tabs flex space-x-2 overflow-x-auto mb-4">
              <li data-id="all" class="cursor-pointer px-4 py-2 bg-gray-300 rounded active">All</li>
            </ul>
            <div class="section-controls flex space-x-2">
              <input type="text" id="new-section-name" placeholder="New Section Name" class="flex-1 border border-gray-300 rounded px-3 py-2">
              <button id="add-section" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Add Section</button>
              <button id="delete-section" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Clear All Todos</button>
            </div>
          </nav>
          <!-- Todo List -->
          <main>
            <div class="todo-controls text-right mb-4">
              <button id="open-todo-modal" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                Add Todo
              </button>
            </div>
            <div id="todo-list" class="todo-list space-y-4">
              <!-- Todos will be rendered here -->
            </div>
          </main>
        </div>
      </div>

      <!-- FRIENDS TAB -->
      <div id="friends-tab" class="p-6 hidden">
        <h2 class="text-xl font-bold mb-4">Friends</h2>
        <div id="friend-add" class="flex items-center mb-4">
          <input type="email" id="friend-email" placeholder="Enter friend's email" class="border border-gray-300 rounded px-3 py-2">
          <button id="send-friend-request" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-2">
            Send Friend Request
          </button>
        </div>
        <div id="incoming-requests" class="mb-4">
          <h3 class="text-lg font-semibold mb-2">Incoming Friend Requests</h3>
          <ul id="friend-requests-list" class="list-disc pl-5"></ul>
        </div>
        <div id="friends-list">
          <h3 class="text-lg font-semibold mb-2">Your Friends</h3>
          <ul id="friends-list-ul" class="list-disc pl-5"></ul>
        </div>
      </div>

      <!-- GROUPS TAB -->
      <div id="groups-tab" class="p-6 hidden">
        <div id="group-list-view">
          <h2 class="text-xl font-bold mb-4">Your Groups</h2>
          <ul id="groups-list" class="space-y-2 mb-4"></ul>
          <div class="flex space-x-2">
            <input type="text" id="new-group-name" placeholder="New Group Name" class="flex-1 border border-gray-300 rounded px-3 py-2">
            <button id="create-group-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
              Create Group
            </button>
          </div>
        </div>
        <div id="group-detail-view" class="hidden">
          <button id="back-to-groups" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded mb-4">
            Back to Groups
          </button>
          <h2 id="group-name-header" class="text-2xl font-bold mb-4"></h2>
          <div id="group-subtabs" class="flex space-x-2 mb-4">
            <button class="group-subtab-btn active px-4 py-2 bg-blue-600 text-white rounded" data-tab="chat">Chat</button>
            <button class="group-subtab-btn px-4 py-2 bg-blue-600 text-white rounded" data-tab="todos">Todos</button>
            <button class="group-subtab-btn px-4 py-2 bg-blue-600 text-white rounded" data-tab="leaderboard">Leaderboard</button>
          </div>
          <div id="group-chat-tab" class="group-tab-content block">
            <div id="group-messages" class="max-h-72 overflow-y-auto border border-gray-300 rounded p-4 mb-4"></div>
            <div class="flex space-x-2">
              <input type="text" id="group-message-input" placeholder="Type a message" class="flex-1 border border-gray-300 rounded px-3 py-2">
              <button id="send-group-message" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                Send
              </button>
            </div>
          </div>
          <div id="group-todos-tab" class="group-tab-content hidden">
            <button id="open-group-todo-modal" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mb-4">
              Add Group Todo
            </button>
            <div id="group-todo-list" class="space-y-4"></div>
          </div>
          <div id="group-leaderboard-tab" class="group-tab-content hidden">
            <h3 class="text-lg font-semibold mb-2">Group Leaderboard</h3>
            <ul id="group-leaderboard-list" class="list-disc pl-5"></ul>
          </div>
        </div>
      </div>

      <!-- NOTIFICATIONS TAB -->
      <div id="notifications-tab" class="p-6 hidden">
        <h2 class="text-xl font-bold mb-4">Notifications</h2>
        <div class="flex items-center mb-4">
          <input type="checkbox" id="mute-notifications" class="mr-2">
          <label for="mute-notifications">Mute Notifications</label>
        </div>
        <ul id="notifications-list" class="list-disc pl-5"></ul>
      </div>
    </div>
  </div>

  <!-- Personal Todo Modal -->
  <div id="todo-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white p-6 rounded w-11/12 max-w-md relative">
      <span id="close-todo-modal" class="close-modal absolute top-2 right-3 text-2xl cursor-pointer">&times;</span>
      <h2 id="modal-title" class="text-xl font-bold mb-4">Add Todo</h2>
      <form id="todo-form" class="space-y-4">
        <div>
          <label class="block mb-1">Title:</label>
          <input type="text" id="todo-title" required class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">Description:</label>
          <textarea id="todo-description" rows="3" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
        </div>
        <div>
          <label class="block mb-1">Deadline:</label>
          <input type="datetime-local" id="todo-deadline" class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">Files:</label>
          <input type="file" id="todo-files" multiple class="w-full">
        </div>
        <div>
          <label class="block mb-1">Links (comma separated):</label>
          <input type="text" id="todo-links" placeholder="https://example.com, https://..." class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">Section:</label>
          <select id="todo-section" class="w-full border border-gray-300 rounded px-3 py-2">
            <option value="all">All</option>
          </select>
        </div>
        <button type="submit" id="save-todo" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
          Save
        </button>
      </form>
    </div>
  </div>

  <!-- Group Todo Modal -->
  <div id="group-todo-modal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="modal-content bg-white p-6 rounded w-11/12 max-w-md relative">
      <span id="close-group-todo-modal" class="close-modal absolute top-2 right-3 text-2xl cursor-pointer">&times;</span>
      <h2 id="group-todo-modal-title" class="text-xl font-bold mb-4">Add Group Todo</h2>
      <form id="group-todo-form" class="space-y-4">
        <div>
          <label class="block mb-1">Title:</label>
          <input type="text" id="group-todo-title" required class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">Description:</label>
          <textarea id="group-todo-description" rows="3" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
        </div>
        <div>
          <label class="block mb-1">Deadline:</label>
          <input type="datetime-local" id="group-todo-deadline" class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">On-Time Reward:</label>
          <input type="number" id="group-todo-on-time" value="10" class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">Late Reward:</label>
          <input type="number" id="group-todo-late" value="5" class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div>
          <label class="block mb-1">Penalty for Failure:</label>
          <input type="number" id="group-todo-penalty" value="-5" class="w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
          Save
        </button>
      </form>
    </div>
  </div>

  <script>
    /***** FIREBASE CONFIGURATION & INITIALIZATION *****/
    const firebaseConfig = {
      apiKey: "AIzaSyBVf8aAxzUFsQXXjIMjjpPSGJFDgmtQHXU",
      authDomain: "todo-be6fb.firebaseapp.com",
      projectId: "todo-be6fb",
      storageBucket: "todo-be6fb.firebasestorage.app",
      messagingSenderId: "844080666799",
      appId: "1:844080666799:web:2b1a22d82993c07d585c5a",
      measurementId: "G-8B1ERE2FXH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /***** GLOBAL VARIABLES *****/
    let currentUser = null;
    // For personal todos
    let personalSections = [];
    let personalTodos = [];
    let editingTodoId = null;
    // For Friends
    let friendRequests = [];
    let friendsList = [];
    // For Groups
    let groups = [];
    let currentGroup = null;
    let groupMessages = [];
    let groupTodos = [];
    let editingGroupTodoId = null;
    // For Notifications
    let notifications = [];
    let muteNotifications = false;

    /***** DOM ELEMENTS *****/
    // Common
    const loginContainer = document.getElementById("login-container");
    const loginButton = document.getElementById("login-button");
    const appContainer = document.getElementById("app-container");
    const logoutButton = document.getElementById("logout-button");
    // Main Tabs
    const tabButtons = document.querySelectorAll("#main-tabs .tab-btn");
    const tabContents = document.querySelectorAll("#tab-contents > div");
    // Personal Todos
    const sectionTabsEl = document.getElementById("section-tabs");
    const newSectionNameEl = document.getElementById("new-section-name");
    const addSectionBtn = document.getElementById("add-section");
    const deleteSectionBtn = document.getElementById("delete-section");
    const todoListEl = document.getElementById("todo-list");
    const openTodoModalBtn = document.getElementById("open-todo-modal");
    const todoModalEl = document.getElementById("todo-modal");
    const closeTodoModalBtn = document.getElementById("close-todo-modal");
    const modalTitleEl = document.getElementById("modal-title");
    const todoForm = document.getElementById("todo-form");
    const todoTitleEl = document.getElementById("todo-title");
    const todoDescriptionEl = document.getElementById("todo-description");
    const todoDeadlineEl = document.getElementById("todo-deadline");
    const todoFilesEl = document.getElementById("todo-files");
    const todoLinksEl = document.getElementById("todo-links");
    const todoSectionSelectEl = document.getElementById("todo-section");
    // Friends
    const friendEmailEl = document.getElementById("friend-email");
    const sendFriendRequestBtn = document.getElementById("send-friend-request");
    const friendRequestsListEl = document.getElementById("friend-requests-list");
    const friendsListUlEl = document.getElementById("friends-list-ul");
    // Groups
    const groupsListEl = document.getElementById("groups-list");
    const newGroupNameEl = document.getElementById("new-group-name");
    const createGroupBtn = document.getElementById("create-group-btn");
    const groupListViewEl = document.getElementById("group-list-view");
    const groupDetailViewEl = document.getElementById("group-detail-view");
    const backToGroupsBtn = document.getElementById("back-to-groups");
    const groupNameHeaderEl = document.getElementById("group-name-header");
    const groupSubtabBtns = document.querySelectorAll(".group-subtab-btn");
    const groupChatTabEl = document.getElementById("group-chat-tab");
    const groupTodosTabEl = document.getElementById("group-todos-tab");
    const groupLeaderboardTabEl = document.getElementById("group-leaderboard-tab");
    const groupMessagesEl = document.getElementById("group-messages");
    const groupMessageInputEl = document.getElementById("group-message-input");
    const sendGroupMessageBtn = document.getElementById("send-group-message");
    const groupTodoListEl = document.getElementById("group-todo-list");
    const openGroupTodoModalBtn = document.getElementById("open-group-todo-modal");
    // Group Todo Modal
    const groupTodoModalEl = document.getElementById("group-todo-modal");
    const closeGroupTodoModalBtn = document.getElementById("close-group-todo-modal");
    const groupTodoForm = document.getElementById("group-todo-form");
    const groupTodoTitleEl = document.getElementById("group-todo-title");
    const groupTodoDescriptionEl = document.getElementById("group-todo-description");
    const groupTodoDeadlineEl = document.getElementById("group-todo-deadline");
    const groupTodoOnTimeEl = document.getElementById("group-todo-on-time");
    const groupTodoLateEl = document.getElementById("group-todo-late");
    const groupTodoPenaltyEl = document.getElementById("group-todo-penalty");
    // Notifications
    const muteNotificationsEl = document.getElementById("mute-notifications");
    const notificationsListEl = document.getElementById("notifications-list");

    /***** TAB SWITCHING *****/
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const tabName = btn.getAttribute("data-tab");
        tabContents.forEach(content => {
          if(content.id === tabName + "-tab") {
            content.classList.remove("hidden");
            content.classList.add("block");
          } else {
            content.classList.remove("block");
            content.classList.add("hidden");
          }
        });
      });
    });
    /***** GROUP SUBTABS *****/
    document.querySelectorAll("#group-subtabs .group-subtab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("#group-subtabs .group-subtab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const subTab = btn.getAttribute("data-tab");
        groupChatTabEl.classList.toggle("block", subTab === "chat");
        groupChatTabEl.classList.toggle("hidden", subTab !== "chat");
        groupTodosTabEl.classList.toggle("block", subTab === "todos");
        groupTodosTabEl.classList.toggle("hidden", subTab !== "todos");
        groupLeaderboardTabEl.classList.toggle("block", subTab === "leaderboard");
        groupLeaderboardTabEl.classList.toggle("hidden", subTab !== "leaderboard");
      });
    });

    /***** AUTHENTICATION HANDLERS *****/
    loginButton.addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    });
    logoutButton.addEventListener("click", () => {
      auth.signOut();
    });
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginContainer.classList.add("hidden");
        appContainer.classList.remove("hidden");
        // Ensure user document exists
        db.collection("users").doc(currentUser.uid).get().then(doc => {
          if (!doc.exists) {
            db.collection("users").doc(currentUser.uid).set({
              email: currentUser.email,
              displayName: currentUser.displayName,
              photoURL: currentUser.photoURL,
              friends: [],
              muteNotifications: false
            });
          }
        });
        setupPersonalTodoListeners();
        setupFriendsListener();
        setupGroupsListener();
        setupNotificationsListener();
      } else {
        currentUser = null;
        loginContainer.classList.remove("hidden");
        appContainer.classList.add("hidden");
      }
    });

    /***** PERSONAL TODOS FUNCTIONS *****/
    function setupPersonalTodoListeners() {
      // Listen for sections
      db.collection("sections")
        .where("userId", "==", currentUser.uid)
        .onSnapshot(snapshot => {
          personalSections = [];
          snapshot.forEach(doc => {
            personalSections.push({ id: doc.id, ...doc.data() });
          });
          renderPersonalSections();
        });
      // Listen for todos
      db.collection("todos")
        .where("userId", "==", currentUser.uid)
        .onSnapshot(snapshot => {
          personalTodos = [];
          snapshot.forEach(doc => {
            personalTodos.push({ id: doc.id, ...doc.data() });
          });
          renderPersonalTodos();
        });
    }
    function renderPersonalSections() {
      sectionTabsEl.innerHTML = "";
      // Always include "All"
      const allTab = document.createElement("li");
      allTab.textContent = "All";
      allTab.dataset.id = "all";
      allTab.classList.add("cursor-pointer", "px-4", "py-2", "bg-gray-300", "rounded", "active");
      allTab.addEventListener("click", () => {
        renderPersonalTodos("all");
      });
      sectionTabsEl.appendChild(allTab);
      // Render user-created sections
      personalSections.forEach(section => {
        const li = document.createElement("li");
        li.textContent = section.name;
        li.dataset.id = section.id;
        li.classList.add("cursor-pointer", "px-4", "py-2", "bg-gray-300", "rounded", "hover:bg-blue-600", "hover:text-white");
        li.addEventListener("click", () => {
          renderPersonalTodos(section.id);
        });
        sectionTabsEl.appendChild(li);
      });
      // Update select options in modal
      todoSectionSelectEl.innerHTML = `<option value="all">All</option>`;
      personalSections.forEach(section => {
        const option = document.createElement("option");
        option.value = section.id;
        option.textContent = section.name;
        todoSectionSelectEl.appendChild(option);
      });
    }
    function renderPersonalTodos(filterSection = "all") {
      todoListEl.innerHTML = "";
      let filtered = filterSection === "all" ? personalTodos : personalTodos.filter(todo => todo.sectionId === filterSection);
      filtered.sort((a, b) => b.createdAt - a.createdAt);
      filtered.forEach(todo => {
        const div = document.createElement("div");
        div.className = "todo-item border border-gray-300 rounded p-4 relative" + (todo.completed ? " opacity-50 line-through" : "");
        div.dataset.id = todo.id;
        let html = `<h3 class="text-xl font-semibold mb-2">${todo.title}</h3>`;
        if (todo.description) { html += `<p class="mb-2">${todo.description}</p>`; }
        if (todo.deadline) {
          html += `<div class="deadline text-red-600 mb-2">Deadline: ${new Date(todo.deadline).toLocaleString()}</div>`;
          html += `<div class="countdown font-bold mb-2" id="countdown-${todo.id}">Calculating time left…</div>`;
          html += `<div class="progress-container bg-gray-200 h-2 rounded mb-2"><div class="progress-bar h-2 bg-green-500 rounded" id="progress-${todo.id}" style="width: 0%"></div></div>`;
        }
        if (todo.files && todo.files.length) {
          html += `<div class="attachments mb-2">Files: `;
          todo.files.forEach(file => {
            if (file.dataURL && file.dataURL.startsWith("data:image"))
              html += `<span class="inline-block mr-2"><img src="${file.dataURL}" alt="${file.name}" class="max-h-8 inline-block align-middle"> ${file.name}</span>`;
            else html += `<span class="inline-block mr-2">${file.name}</span>`;
          });
          html += `</div>`;
        }
        if (todo.links && todo.links.length) {
          html += `<div class="links mb-2">Links: `;
          todo.links.forEach(link => {
            html += `<a href="${link.trim()}" target="_blank" class="text-blue-600 underline">${link.trim()}</a> `;
          });
          html += `</div>`;
        }
        html += `<div class="actions absolute top-2 right-2 flex space-x-2">
                   <button class="complete-btn bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">${todo.completed ? "Undo" : "Complete"}</button>
                   <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded">Edit</button>
                   <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">Delete</button>
                 </div>`;
        div.innerHTML = html;
        div.querySelector(".complete-btn").addEventListener("click", () => {
          db.collection("todos").doc(todo.id).update({ completed: !todo.completed });
        });
        div.querySelector(".edit-btn").addEventListener("click", () => openTodoModal(todo.id));
        div.querySelector(".delete-btn").addEventListener("click", () => {
          if (confirm("Are you sure you want to delete this todo?"))
            db.collection("todos").doc(todo.id).delete();
        });
        todoListEl.appendChild(div);
      });
    }
    function updateCountdowns() {
      const now = Date.now();
      personalTodos.forEach(todo => {
        if (todo.deadline) {
          const deadlineTime = new Date(todo.deadline).getTime();
          const countdownEl = document.getElementById("countdown-" + todo.id);
          const progressBarEl = document.getElementById("progress-" + todo.id);
          if (countdownEl && progressBarEl) {
            let timeLeft = deadlineTime - now;
            if (timeLeft <= 0) {
              countdownEl.textContent = "Time's up!";
              progressBarEl.style.width = "100%";
            } else {
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
              const minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
              const seconds = Math.floor((timeLeft / 1000) % 60);
              countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s left`;
              const total = deadlineTime - todo.createdAt;
              const elapsed = now - todo.createdAt;
              let progress = Math.min((elapsed / total) * 100, 100);
              progressBarEl.style.width = progress + "%";
            }
          }
        }
      });
    }
    setInterval(updateCountdowns, 1000);
    function openTodoModal(todoId = null) {
      editingTodoId = todoId;
      todoForm.reset();
      if (todoId) {
        modalTitleEl.textContent = "Edit Todo";
        const todo = personalTodos.find(t => t.id === todoId);
        if (todo) {
          todoTitleEl.value = todo.title;
          todoDescriptionEl.value = todo.description || "";
          if (todo.deadline) {
            const dt = new Date(todo.deadline);
            const tz = dt.getTimezoneOffset() * 60000;
            todoDeadlineEl.value = new Date(dt - tz).toISOString().slice(0,16);
          }
          todoLinksEl.value = todo.links ? todo.links.join(", ") : "";
          todoSectionSelectEl.value = todo.sectionId;
        }
      } else {
        modalTitleEl.textContent = "Add Todo";
        todoSectionSelectEl.value = "all";
      }
      todoModalEl.classList.remove("hidden");
    }
    function closeTodoModal() {
      editingTodoId = null;
      todoModalEl.classList.add("hidden");
      todoFilesEl.value = "";
    }
    function processFiles(files) {
      const arr = Array.from(files);
      const promises = arr.map(file => {
        return new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = (e) => {
            resolve({ name: file.name, dataURL: e.target.result });
          };
          reader.readAsDataURL(file);
        });
      });
      return Promise.all(promises);
    }
    todoForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = todoTitleEl.value.trim();
      if (!title) return;
      const description = todoDescriptionEl.value.trim();
      const deadline = todoDeadlineEl.value ? new Date(todoDeadlineEl.value).toISOString() : null;
      const links = todoLinksEl.value ? todoLinksEl.value.split(",").map(l => l.trim()).filter(l => l) : [];
      const sectionId = todoSectionSelectEl.value || "all";
      let files = [];
      if (todoFilesEl.files.length) {
        files = await processFiles(todoFilesEl.files);
      }
      if (editingTodoId) {
        const ref = db.collection("todos").doc(editingTodoId);
        const updateData = { title, description, deadline, links, sectionId };
        if (files.length) {
          updateData.files = firebase.firestore.FieldValue.arrayUnion(...files);
        }
        ref.update(updateData);
      } else {
        db.collection("todos").add({
          userId: currentUser.uid,
          title,
          description,
          completed: false,
          deadline,
          createdAt: Date.now(),
          files,
          links,
          sectionId: sectionId || "all"
        });
      }
      closeTodoModal();
    });
    openTodoModalBtn.addEventListener("click", () => openTodoModal());
    closeTodoModalBtn.addEventListener("click", closeTodoModal);
    todoModalEl.addEventListener("click", (e) => { if (e.target === todoModalEl) closeTodoModal(); });
    addSectionBtn.addEventListener("click", () => {
      const name = newSectionNameEl.value.trim();
      if (name) {
        db.collection("sections").add({ userId: currentUser.uid, name });
        newSectionNameEl.value = "";
      }
    });
    deleteSectionBtn.addEventListener("click", () => {
      if (confirm("Delete all todos?")) {
        personalTodos.forEach(todo => { db.collection("todos").doc(todo.id).delete(); });
      }
    });

    /***** FRIENDS FUNCTIONS *****/
    function setupFriendsListener() {
      db.collection("friendRequests")
        .where("toUserId", "==", currentUser.uid)
        .where("status", "==", "pending")
        .onSnapshot(snapshot => {
          friendRequests = [];
          snapshot.forEach(doc => { friendRequests.push({ id: doc.id, ...doc.data() }); });
          renderFriendRequests();
        });
      db.collection("users").doc(currentUser.uid)
        .onSnapshot(doc => {
          const data = doc.data();
          friendsList = data.friends || [];
          renderFriendsList();
          muteNotifications = data.muteNotifications || false;
          muteNotificationsEl.checked = muteNotifications;
        });
    }
    function renderFriendRequests() {
      friendRequestsListEl.innerHTML = "";
      friendRequests.forEach(req => {
        const li = document.createElement("li");
        li.textContent = `Friend request from ${req.fromEmail}`;
        const acceptBtn = document.createElement("button");
        acceptBtn.textContent = "Accept";
        acceptBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "text-white", "px-2", "py-1", "rounded", "ml-2");
        acceptBtn.addEventListener("click", () => acceptFriendRequest(req));
        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "Reject";
        rejectBtn.classList.add("bg-red-500", "hover:bg-red-600", "text-white", "px-2", "py-1", "rounded", "ml-2");
        rejectBtn.addEventListener("click", () => rejectFriendRequest(req));
        li.appendChild(acceptBtn);
        li.appendChild(rejectBtn);
        friendRequestsListEl.appendChild(li);
      });
    }
    function renderFriendsList() {
      friendsListUlEl.innerHTML = "";
      friendsList.forEach(friend => {
        const li = document.createElement("li");
        li.textContent = friend.displayName || friend.email;
        friendsListUlEl.appendChild(li);
      });
    }
    sendFriendRequestBtn.addEventListener("click", () => {
      const email = friendEmailEl.value.trim();
      if (!email) return;
      db.collection("users").where("email", "==", email).get().then(snapshot => {
        if (snapshot.empty) {
          alert("User not found.");
        } else {
          snapshot.forEach(doc => {
            const toUser = doc.data();
            db.collection("friendRequests").add({
              fromUserId: currentUser.uid,
              fromEmail: currentUser.email,
              toUserId: doc.id,
              toEmail: toUser.email,
              status: "pending",
              createdAt: Date.now()
            });
          });
          friendEmailEl.value = "";
          if (!muteNotifications) {
            db.collection("notifications").add({
              userId: email,
              message: `${currentUser.displayName} sent you a friend request.`,
              read: false,
              createdAt: Date.now()
            });
          }
        }
      });
    });
    function acceptFriendRequest(req) {
      db.collection("friendRequests").doc(req.id).update({ status: "accepted" });
      const meRef = db.collection("users").doc(currentUser.uid);
      const senderRef = db.collection("users").doc(req.fromUserId);
      meRef.update({ friends: firebase.firestore.FieldValue.arrayUnion({ uid: req.fromUserId, email: req.fromEmail }) });
      senderRef.update({ friends: firebase.firestore.FieldValue.arrayUnion({ uid: currentUser.uid, email: currentUser.email }) });
    }
    function rejectFriendRequest(req) {
      db.collection("friendRequests").doc(req.id).update({ status: "rejected" });
    }

    /***** GROUPS FUNCTIONS *****/
    function setupGroupsListener() {
      db.collection("groups")
        .where("members", "array-contains", currentUser.uid)
        .onSnapshot(snapshot => {
          groups = [];
          snapshot.forEach(doc => { groups.push({ id: doc.id, ...doc.data() }); });
          renderGroupsList();
        });
    }
    function renderGroupsList() {
      groupsListEl.innerHTML = "";
      groups.forEach(group => {
        const li = document.createElement("li");
        li.textContent = group.groupName;
        li.classList.add("cursor-pointer", "px-4", "py-2", "border", "border-gray-300", "rounded", "hover:bg-blue-600", "hover:text-white");
        li.addEventListener("click", () => openGroupDetail(group));
        groupsListEl.appendChild(li);
      });
    }
    createGroupBtn.addEventListener("click", () => {
      const name = newGroupNameEl.value.trim();
      if (!name) return;
      db.collection("groups").add({
        groupName: name,
        createdBy: currentUser.uid,
        members: [currentUser.uid],
        createdAt: Date.now()
      });
      newGroupNameEl.value = "";
    });
    function openGroupDetail(group) {
      currentGroup = group;
      groupListViewEl.classList.add("hidden");
      groupDetailViewEl.classList.remove("hidden");
      groupNameHeaderEl.textContent = group.groupName;
      document.querySelectorAll("#group-subtabs .group-subtab-btn").forEach(b => b.classList.remove("active"));
      document.querySelector("#group-subtabs .group-subtab-btn[data-tab='chat']").classList.add("active");
      groupChatTabEl.classList.remove("hidden");
      groupTodosTabEl.classList.add("hidden");
      groupLeaderboardTabEl.classList.add("hidden");
      setupGroupMessagesListener();
      setupGroupTodosListener();
    }
    backToGroupsBtn.addEventListener("click", () => {
      groupDetailViewEl.classList.add("hidden");
      groupListViewEl.classList.remove("hidden");
      currentGroup = null;
    });
    function setupGroupMessagesListener() {
      if (!currentGroup) return;
      db.collection("groups").doc(currentGroup.id).collection("messages").orderBy("timestamp")
        .onSnapshot(snapshot => {
          groupMessages = [];
          snapshot.forEach(doc => { groupMessages.push({ id: doc.id, ...doc.data() }); });
          renderGroupMessages();
        });
    }
    function renderGroupMessages() {
      groupMessagesEl.innerHTML = "";
      groupMessages.forEach(msg => {
        const div = document.createElement("div");
        div.textContent = `${msg.senderName}: ${msg.message}`;
        groupMessagesEl.appendChild(div);
      });
    }
    sendGroupMessageBtn.addEventListener("click", () => {
      const text = groupMessageInputEl.value.trim();
      if (!text || !currentGroup) return;
      db.collection("groups").doc(currentGroup.id).collection("messages").add({
        senderId: currentUser.uid,
        senderName: currentUser.displayName,
        message: text,
        timestamp: Date.now()
      });
      groupMessageInputEl.value = "";
    });
    function setupGroupTodosListener() {
      if (!currentGroup) return;
      db.collection("groups").doc(currentGroup.id).collection("todos").orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          groupTodos = [];
          snapshot.forEach(doc => { groupTodos.push({ id: doc.id, ...doc.data() }); });
          renderGroupTodos();
          renderGroupLeaderboard();
        });
    }
    function renderGroupTodos() {
      groupTodoListEl.innerHTML = "";
      groupTodos.forEach(todo => {
        const div = document.createElement("div");
        div.className = "todo-item border border-gray-300 rounded p-4 relative" + (todo.completed ? " opacity-50 line-through" : "");
        div.dataset.id = todo.id;
        let html = `<h3 class="text-xl font-semibold mb-2">${todo.title}</h3>`;
        if (todo.description) { html += `<p class="mb-2">${todo.description}</p>`; }
        if (todo.deadline) {
          html += `<div class="deadline text-red-600 mb-2">Deadline: ${new Date(todo.deadline).toLocaleString()}</div>`;
        }
        const completion = todo.completions ? todo.completions.find(c => c.userId === currentUser.uid) : null;
        html += `<div class="actions absolute top-2 right-2">
                   <button class="complete-group-todo-btn bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">${completion ? "Completed" : "Mark as Completed"}</button>
                 </div>`;
        div.innerHTML = html;
        div.querySelector(".complete-group-todo-btn").addEventListener("click", () => {
          if (!completion) {
            db.collection("groups").doc(currentGroup.id).collection("todos").doc(todo.id).update({
              completions: firebase.firestore.FieldValue.arrayUnion({ userId: currentUser.uid, completedAt: Date.now() })
            });
          }
        });
        groupTodoListEl.appendChild(div);
      });
    }
    openGroupTodoModalBtn.addEventListener("click", () => {
      groupTodoForm.reset();
      groupTodoModalEl.classList.remove("hidden");
    });
    closeGroupTodoModalBtn.addEventListener("click", () => {
      groupTodoModalEl.classList.add("hidden");
    });
    groupTodoModalEl.addEventListener("click", (e) => { if (e.target === groupTodoModalEl) groupTodoModalEl.classList.add("hidden"); });
    groupTodoForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const title = groupTodoTitleEl.value.trim();
      if (!title || !currentGroup) return;
      const description = groupTodoDescriptionEl.value.trim();
      const deadline = groupTodoDeadlineEl.value ? new Date(groupTodoDeadlineEl.value).toISOString() : null;
      const onTimeReward = parseInt(groupTodoOnTimeEl.value);
      const lateReward = parseInt(groupTodoLateEl.value);
      const penalty = parseInt(groupTodoPenaltyEl.value);
      db.collection("groups").doc(currentGroup.id).collection("todos").add({
        title,
        description,
        deadline,
        onTimeReward,
        lateReward,
        penalty,
        createdBy: currentUser.uid,
        createdAt: Date.now(),
        completions: []
      });
      groupTodoModalEl.classList.add("hidden");
    });
    function renderGroupLeaderboard() {
  const leaderboard = {};
  groupTodos.forEach(todo => {
    if (todo.completions) {
      todo.completions.forEach(comp => {
        if (!leaderboard[comp.userId]) leaderboard[comp.userId] = 0;
        if (todo.deadline && comp.completedAt <= new Date(todo.deadline).getTime()) {
          leaderboard[comp.userId] += todo.onTimeReward;
        } else if (todo.deadline && comp.completedAt > new Date(todo.deadline).getTime()) {
          leaderboard[comp.userId] += todo.lateReward;
        }
      });
    }
  });

  const lbListEl = document.getElementById("group-leaderboard-list");
  lbListEl.innerHTML = "";

  // For each member ID in the group, fetch their name from Firestore
  currentGroup.members.forEach(memberId => {
    db.collection("users").doc(memberId).get().then(doc => {
      // Use "Unknown" if the document doesn't exist or name field is missing
      const userName = doc.exists && doc.data().name ? doc.data().name : "Unknown";
      const pts = leaderboard[memberId] || 0;
      const li = document.createElement("li");
      li.textContent = `User: ${userName} – Points: ${pts}`;
      lbListEl.appendChild(li);
    }).catch(error => {
      console.error("Error fetching user data for memberId", memberId, error);
    });
  });
}
    

    /***** NOTIFICATIONS FUNCTIONS *****/
    function setupNotificationsListener() {
      db.collection("notifications")
        .where("userId", "==", currentUser.uid)
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          notifications = [];
          snapshot.forEach(doc => { notifications.push({ id: doc.id, ...doc.data() }); });
          renderNotifications();
        });
    }
    function renderNotifications() {
      notificationsListEl.innerHTML = "";
      notifications.forEach(notif => {
        const li = document.createElement("li");
        li.textContent = notif.message;
        notificationsListEl.appendChild(li);
      });
    }
    muteNotificationsEl.addEventListener("change", () => {
      muteNotifications = muteNotificationsEl.checked;
      db.collection("users").doc(currentUser.uid).update({ muteNotifications });
    });
  </script>
</body>
</html>
